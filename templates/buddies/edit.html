{% extends "base.html" %}
{% block title %}Edit buddy session â€” SEA{% endblock %}

{% block content %}
<h1 class="mb-3">Edit buddy session</h1>

<form method="post" class="col-lg-7">
  {% csrf_token %}

  <div class="mb-3">
    <label class="form-label">Title</label>
    {{ form.title }}
    {% for e in form.title.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
  </div>

  <div class="row g-3">
    <div class="col-sm-6">
      <label class="form-label">Type</label>
      {{ form.type }}
    </div>
    <div class="col-sm-6">
      <label class="form-label">Start</label>
      {{ form.start_dt }}
    </div>
  </div>

  <div class="mb-3 mt-3">
    <label class="form-label">Location name</label>
    {{ form.location_name }}
  </div>

  <div class="row g-3">
    <div class="col-sm-4">
      <label class="form-label">Latitude</label>
      {{ form.lat }}
    </div>
    <div class="col-sm-4">
      <label class="form-label">Longitude</label>
      {{ form.lon }}
    </div>
    <div class="col-sm-4">
      <label class="form-label">Capacity</label>
      {{ form.capacity }}
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#pickMapModal">
      Pick on map
    </button>
    <button class="btn btn-primary">Save changes</button>
    <a class="btn btn-outline-secondary" href="{% url 'buddies:detail' sess.id %}">Cancel</a>
  </div>
</form>

{# Map picker modal (same as create page) #}
<div class="modal fade" id="pickMapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Pick a location</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="pick-map" style="height: 360px; border-radius: .5rem;"></div>
        <p class="text-muted small mt-2">
          Click on the map to set latitude/longitude. You can tweak the values afterwards.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">Done</button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  let map, marker;

  function ensureMap() {
    if (map || typeof L === 'undefined') return;
    map = L.map('pick-map').setView([52.68, -9.00], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

    // seed from current values if present
    const latEl = document.getElementById('id_lat');
    const lonEl = document.getElementById('id_lon');
    const lat = parseFloat(latEl.value);
    const lon = parseFloat(lonEl.value);
    if (!isNaN(lat) && !isNaN(lon)) {
      marker = L.marker([lat, lon], {draggable: true}).addTo(map);
      map.setView([lat, lon], 13);
      marker.on('dragend', () => {
        const p = marker.getLatLng();
        latEl.value = p.lat.toFixed(6);
        lonEl.value = p.lng.toFixed(6);
      });
    }

    map.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (!marker) {
        marker = L.marker([lat, lng], {draggable: true}).addTo(map);
        marker.on('dragend', () => {
          const p = marker.getLatLng();
          latEl.value = p.lat.toFixed(6);
          lonEl.value = p.lng.toFixed(6);
        });
      } else {
        marker.setLatLng([lat, lng]);
      }
      latEl.value = lat.toFixed(6);
      lonEl.value = lng.toFixed(6);
    });

    setTimeout(() => map.invalidateSize(), 0);
    setTimeout(() => map.invalidateSize(), 150);
  }

  // init when modal opens
  document.addEventListener('shown.bs.modal', function (e) {
    if (e.target.id === 'pickMapModal') ensureMap();
  });
})();
</script>
{% endblock %}
