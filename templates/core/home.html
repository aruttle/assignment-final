{% extends "base.html" %}
{% load static %}
{% block title %}SEA — Home{% endblock %}

{% block content %}

<!-- Hero -->
<section class="hero hero-sea mb-4 rounded-3 overflow-hidden"
         style="background-image: url('{% static "images/estuary-hero.png" %}');">
  <div class="hero-overlay">
    <div class="container py-5">
      <div class="col-lg-10 text-white">
        <h1 class="display-5 fw-bold mb-2">Reconnect with the Shannon Estuary</h1>
        <p class="lead mb-4">Bookings, buddy sessions, and safety info—together in one place.</p>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-brand btn-lg" href="{% url 'activities:list' %}">Explore activities</a>
          <a class="btn btn-outline-light btn-lg" href="#map">View map</a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Welcome split -->
<section class="mb-5">
  <div class="row g-4 align-items-center">
    <div class="col-lg-7">
      <h2 class="h3 mb-3">Welcome to Shannon Estuary Activities</h2>
      <p class="mb-3">
        Plan with confidence. Discover guided adventures, find buddies for swims, kayaks, hikes or cycles,
        and check live safety conditions—tailored for the estuary.
      </p>
      <ul class="list-unstyled mb-0">
        <li class="mb-1">• Book activities with local providers</li>
        <li class="mb-1">• Create or join buddy sessions</li>
        <li>• Check weather & tides inside the safety panel</li>
      </ul>
    </div>
    <div class="col-lg-5">
      <img src="{% static 'images/welcome.jpg' %}" alt="Wildflowers along the Shannon Estuary coast"
           class="img-fluid rounded-3 shadow-sm">
    </div>
  </div>
</section>

<!-- Map + Safety -->
<section class="mb-4" aria-labelledby="map-heading">
  <h2 id="map-heading" class="h4">Map</h2>
  <div id="map" class="mb-3" role="region" aria-label="Activity map"></div>

  <!-- HTMX + Leaflet: load spots JSON on page load -->
  <div id="spot-data"
       hx-get="{% url 'core:spots_geojson' %}"
       hx-trigger="load"
       hx-swap="none"></div>

  <script>
    // Listen for the HTMX response and push spots into Leaflet
    document.body.addEventListener('htmx:afterOnLoad', function (e) {
      if (e.target.id === 'spot-data') {
        try {
          const data = JSON.parse(e.detail.xhr.responseText);
          if (window.updateSpots) updateSpots(data);
        } catch (_) {}
      }
    });
  </script>

  <!-- Safety panel target (map popups load into this via HTMX) -->
  <div id="safety-panel" class="mt-3" aria-live="polite">
    <span class="htmx-indicator small text-muted">Loading safety…</span>
  </div>
</section>

<!-- Discover Spots (Swiper) -->
<section class="mb-5" aria-labelledby="discover-heading">
  <h2 id="discover-heading" class="h4">Discover spots</h2>

  <div class="swiper sea-swiper">
    <div class="swiper-wrapper" id="spot-swiper-wrapper">
      {# slides injected from JS based on /spots.json #}
    </div>

    <!-- Controls -->
    <div class="swiper-button-prev" aria-label="Previous"></div>
    <div class="swiper-button-next" aria-label="Next"></div>
    <div class="swiper-pagination" aria-label="Slides"></div>
  </div>
</section>

<script>
/* Build Swiper slides from your existing /spots.json payload.
   Does nothing until HTMX loads #spot-data (already on this page). */
(function(){
  let spotSwiper;

  function initSwiper(){
    if (typeof Swiper === "undefined") return null;
    if (spotSwiper) return spotSwiper;
    spotSwiper = new Swiper(".sea-swiper", {
      slidesPerView: 1.1,
      spaceBetween: 12,
      centeredSlides: false,
      a11y: { enabled: true },
      pagination: { el: ".swiper-pagination", clickable: true },
      navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
      breakpoints: {
        576: { slidesPerView: 2 },
        768: { slidesPerView: 3 },
        992: { slidesPerView: 4 }
      }
    });
    return spotSwiper;
  }

  function renderSpotSlides(geojson){
    const wrap = document.getElementById("spot-swiper-wrapper");
    if (!wrap) return;
    wrap.innerHTML = "";

    const feats = (geojson && Array.isArray(geojson.features)) ? geojson.features.slice(0, 12) : [];
    feats.forEach(f=>{
      const p = f.properties || {};
      const coords = (f.geometry && f.geometry.coordinates) || [null,null];
      const lon = coords[0], lat = coords[1];
      const title = p.name || "Spot";
      const type = p.type || "";

      const slide = document.createElement("div");
      slide.className = "swiper-slide";
      slide.innerHTML = `
        <div class="spot-card shadow-sm">
          <div class="spot-card-body">
            ${type ? `<div class="badge rounded-pill text-bg-light mb-2">${type}</div>` : ``}
            <h3 class="h6 mb-2">${title}</h3>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary"
                ${lat!=null && lon!=null
                   ? `hx-get="{% url 'safety:panel' %}?lat=${lat}&lon=${lon}" hx-target="#safety-panel" hx-swap="innerHTML"`
                   : `disabled`}>Check conditions</button>
              ${lat!=null && lon!=null
                   ? `<button type="button" class="btn btn-sm btn-outline-secondary" data-lat="${lat}" data-lon="${lon}">View on map</button>`
                   : ``}
            </div>
          </div>
        </div>`;
      wrap.appendChild(slide);
    });

    const sw = initSwiper();
    if (sw) sw.update();
  }

  // Public hook (if needed elsewhere)
  window._seaRenderSpotSlides = renderSpotSlides;

  // Init once DOM is ready (Swiper assets loaded from base.html)
  document.addEventListener("DOMContentLoaded", initSwiper);

  // Tie into your existing HTMX load for #spot-data
  document.body.addEventListener("htmx:afterOnLoad", function (e) {
    if (e.target.id === "spot-data") {
      try {
        const data = JSON.parse(e.detail.xhr.responseText);
        if (window.updateSpots) updateSpots(data);     // keep your current map behavior
        renderSpotSlides(data);                        // build slides
      } catch (_) {}
    }
  });

  // Optional: pan map when "View on map" is clicked
  document.addEventListener("click", function(e){
    const btn = e.target.closest("[data-lat][data-lon]");
    if (!btn) return;
    const lat = parseFloat(btn.getAttribute("data-lat"));
    const lon = parseFloat(btn.getAttribute("data-lon"));
    if (window.panToSpot) { window.panToSpot(lat, lon); }
    else if (window.map && typeof window.map.setView === "function") {
      window.map.setView([lat, lon], 12);
    }
  });
})();
</script>

{% endblock %}
